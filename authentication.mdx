---
title: "Autenticação"
description: "Como autenticar suas requisições na API Safefy"
---

A Safefy utiliza **OAuth2 Client Credentials** para autenticação. Você precisa obter um token JWT antes de fazer qualquer outra requisição.

## Como funciona

```mermaid
sequenceDiagram
    participant App as Sua Aplicação
    participant Safefy as API Safefy
    
    App->>Safefy: POST /v1/auth/token (credenciais)
    Safefy-->>App: Token JWT (expira em 1h)
    App->>Safefy: GET /v1/transactions (Authorization: Bearer token)
    Safefy-->>App: Dados da transação
```

## Limite de geração de token (importante)

Para proteger sua integração, existe um limite de **10 tokens por hora** para cada credencial.

Em termos simples: se sua aplicação ficar pedindo token toda hora, ela pode ser bloqueada temporariamente com erro `429`.

<Warning>
Você não deve gerar um novo token a cada requisição. Gere 1 token, salve e reutilize até ele expirar.
</Warning>

## Obtendo o token

```bash
curl -X POST https://api-payment.safefypay.com.br/v1/auth/token \
  -H "Content-Type: application/json" \
  -d '{
    "grantType": "client_credentials",
    "publicKey": "pk_sandbox_abc123...",
    "secretKey": "sk_sandbox_xyz789..."
  }'
```

**Resposta:**

```json
{
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenType": "Bearer",
    "expiresIn": 3600,
    "environment": "Sandbox"
  }
}
```

## Usando o token

Inclua o token no header `Authorization` de todas as requisições:

```bash
curl https://api-payment.safefypay.com.br/v1/transactions \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

<Warning>
O token expira em **1 hora** (3600 segundos). Renove-o antes da expiração para evitar interrupções.
</Warning>

## Como evitar bloqueio de forma simples

Pense no token como um “ingresso” válido por 1 hora:

1. Gere o token uma vez.
2. Salve o `accessToken` e a data/hora de expiração.
3. Antes de pedir novo token, verifique se já existe um salvo e ainda válido.
4. Se ainda estiver válido, use o mesmo token.
5. Só gere outro quando estiver expirado (ou muito perto de expirar).

Exemplo simples de lógica:

```text
se existe token salvo E agora < dataExpiracao:
  usar token salvo
senao:
  gerar novo token
  salvar token + dataExpiracao
```

<Tip>
Uma prática segura é renovar alguns minutos antes da expiração (ex.: 2 a 5 minutos) para evitar falha por diferença de relógio entre servidores.
</Tip>

---

## Boas práticas de segurança

<CardGroup cols={2}>
  <Card title="Nunca exponha a secretKey" icon="shield">
    Mantenha a secretKey apenas no backend. Nunca a inclua em código frontend ou repositórios públicos.
  </Card>
  <Card title="Use variáveis de ambiente" icon="lock">
    Armazene suas credenciais em variáveis de ambiente ou serviços de secrets (AWS Secrets Manager, Vault, etc).
  </Card>
  <Card title="Renove antes de expirar" icon="rotate">
    Implemente logica para renovar o token antes dos 3600 segundos expirarem.
  </Card>
  <Card title="Configure IPs permitidos" icon="network-wired">
    No painel Safefy, restrinja o uso das credenciais apenas aos IPs do seu servidor.
  </Card>
</CardGroup>

---

## Erros comuns

| Codigo | Erro | Solução |
|--------|------|---------|
| 401 | Credenciais inválidas | Verifique publicKey e secretKey |
| 403 | IP não autorizado | Adicione o IP nas configurações da credencial |
| 429 | Limite de tokens excedido (`auth_rate_limit_exceeded`) | Reutilize o token já salvo até expirar e respeite o `Retry-After` |

<Card title="Testar autenticacao" icon="play" href="/api-reference/auth/token">
  Experimente o endpoint de autenticação no playground.
</Card>
